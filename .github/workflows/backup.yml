name: Sync Release from Other Repo

on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'ç›®æ ‡é¡¹ç›®ä»“åº“ï¼ˆæ ¼å¼: owner/repoï¼‰'
        required: true
        type: string
      release_tag:
        description: 'è¦åŒæ­¥çš„ Release æ ‡ç­¾ï¼ˆtagï¼‰'
        required: true
        type: string

jobs:
  sync-release:
    runs-on: ubuntu-latest

    steps:
      - name: è®¾ç½®å˜é‡
        run: |
          echo "REPO=${{ github.event.inputs.repo }}" >> $GITHUB_ENV
          echo "RELEASE_TAG=${{ github.event.inputs.release_tag }}" >> $GITHUB_ENV

      - name: ç¡®ä¿å·²å®‰è£… jq å’Œ gh
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: æ£€æŸ¥å¹¶åˆ›å»ºå½“å‰ä»“åº“çš„ Releaseï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰
        run: |
          echo "æ£€æŸ¥ Release æ˜¯å¦å­˜åœ¨: $RELEASE_TAG"
          if ! gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" > /dev/null 2>&1; then
            echo "ğŸ”§ å½“å‰ä»“åº“æœªæ‰¾åˆ° Releaseï¼Œæ­£åœ¨åˆ›å»º..."
            gh release create "$RELEASE_TAG" --repo "${{ github.repository }}" \
              --title "åŒæ­¥è‡ª $REPO çš„ Release" \
              --notes "è¯¥ç‰ˆæœ¬èµ„äº§æ¥è‡ª $REPO@$RELEASE_TAGï¼Œè‡ªåŠ¨åŒæ­¥äº $(date '+%Y-%m-%d %H:%M:%S')"
          else
            echo "âœ… Release å·²å­˜åœ¨ï¼Œç»§ç»­ä¸Šä¼ èµ„äº§"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–ç›®æ ‡ Release çš„èµ„äº§åˆ—è¡¨
        run: |
          API_URL="https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG"
          echo "Fetching: $API_URL"
          curl -s "$API_URL" | jq -r '.assets[] | "\(.name)|\(.browser_download_url)"' > assets.txt

      - name: é€ä¸ªä¸‹è½½ + ä¸Šä¼  + åˆ é™¤
        run: |
          mkdir -p temp
          while IFS='|' read -r NAME URL; do
            echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½: $NAME"
            curl -L "$URL" -o "temp/$NAME"

            echo "â¬†ï¸ æ­£åœ¨ä¸Šä¼ : $NAME"
            gh release upload "$RELEASE_TAG" "temp/$NAME" --repo "${{ github.repository }}" --clobber

            echo "ğŸ§¹ åˆ é™¤: $NAME"
            rm -f "temp/$NAME"
          done < assets.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Sync Release from Other Repo

on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'ç›®æ ‡é¡¹ç›®ä»“åº“ï¼ˆå¦‚ owner/repoï¼‰'
        required: true
        type: string
      release_tag:
        description: 'è¦åŒæ­¥çš„ Release æ ‡ç­¾ï¼ˆtagï¼‰'
        required: true
        type: string

permissions:
  contents: write

jobs:
  sync-release:
    runs-on: ubuntu-latest

    steps:
      - name: è®¾ç½®å˜é‡
        run: |
          echo "REPO=${{ github.event.inputs.repo }}" >> $GITHUB_ENV
          echo "RELEASE_TAG=${{ github.event.inputs.release_tag }}" >> $GITHUB_ENV

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: è·å–æº Release ä¿¡æ¯
        run: |
          release_json=$(curl -s "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG")
          echo "$release_json" > release.json

          title=$(jq -r '.name // .tag_name' release.json)
          body=$(jq -r '.body // empty' release.json)
          draft=$(jq -r '.draft' release.json)
          prerelease=$(jq -r '.prerelease' release.json)

          # è®¾ç½® title
          {
            echo "TITLE<<EOF"
            echo "$title"
            echo "EOF"
          } >> $GITHUB_ENV

          # è®¾ç½® body + æ¥æºè¿½æº¯ä¿¡æ¯ï¼ˆä¿æŒ markdown æ ¼å¼ï¼‰
          {
            echo "BODY<<EOF"
            echo "$body"
            echo
            echo "---"
            echo "æœ¬ Release ç”±è‡ªåŠ¨åŒæ­¥è„šæœ¬ç”Ÿæˆï¼Œæ¥æºï¼š[${REPO}@${RELEASE_TAG}](https://github.com/${REPO}/releases/tag/${RELEASE_TAG})"
            echo "EOF"
          } >> $GITHUB_ENV

          echo "IS_DRAFT=$draft" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$prerelease" >> $GITHUB_ENV

      - name: åˆ›å»º Releaseï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰
        run: |
          if ! gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" > /dev/null 2>&1; then
            echo "åˆ›å»ºæ–° Release: $TITLE"
            args=(--repo "${{ github.repository }}" --title "$TITLE" --notes "$BODY")
            [[ "$IS_DRAFT" == "true" ]] && args+=("--draft")
            [[ "$IS_PRERELEASE" == "true" ]] && args+=("--prerelease")
            gh release create "$RELEASE_TAG" "${args[@]}"
          else
            echo "âœ… Release å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TITLE: ${{ env.TITLE }}
          BODY: ${{ env.BODY }}
          IS_DRAFT: ${{ env.IS_DRAFT }}
          IS_PRERELEASE: ${{ env.IS_PRERELEASE }}

      - name: è·å–èµ„äº§åˆ—è¡¨
        run: |
          curl -s "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG" \
          | jq -r '.assets[] | "\(.name)|\(.browser_download_url)"' > assets.txt

      - name: ä¸‹è½½ + ä¸Šä¼  + åˆ é™¤èµ„äº§
        run: |
          mkdir -p temp
          while IFS='|' read -r NAME URL; do
            echo "â¬‡ï¸ ä¸‹è½½: $NAME"
            curl -L "$URL" -o "temp/$NAME"

            echo "â¬†ï¸ ä¸Šä¼ : $NAME"
            gh release upload "$RELEASE_TAG" "temp/$NAME" --repo "${{ github.repository }}" --clobber

            echo "ğŸ§¹ åˆ é™¤: $NAME"
            rm -f "temp/$NAME"
          done < assets.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}